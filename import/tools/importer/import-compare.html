<html>
    <head>
        <title>Compare Tool</title>
        <style>
            .form {
                padding-bottom: 5;
                text-align: center;
            }
            .url-display {
                width: 50%;
                margin-top: 10px;
                border: ridge;
                padding: 5px 2px 5px 10px
            }
            .url-display > a {
                color: black;
                text-decoration: none;
            }
            .frames {
                width: 100%;
                height: 100%;
                display: flex;
            }
            .frame-box {
                width: 50%;
                height: 100%;
                border: none;
                margin: 0;
                padding: 0;
                border: inset;
            }
            .frame {
                width: 200%;
                height: 200%;
                border: none;
                margin: 0;
                padding: 0;
                transform: scale(0.5) translate(-50%, -50%);
            }
            .publish-ui {
                margin-top: 20px;
            }
            .publish-logger-container {
                border: none;
                display: none;
            }
            .publish-logger {
                border: none;
                width: 100%;
                margin-bottom: 10;
            }
            .url {
                margin-left: 0;
            }
            .url input {
                border: 0;
            }
            .publish-op {
                margin-left: 50;
            }
            .log-btn {
                display: none;
                align-self: center;
            }
            #prev-btn {
                margin-left: 50;
            }
            #url-text {
                width: 95%;
            }
        </style>
        <script src="./bulk.js" defer></script>
        <script>
            /*
            let focusFrameId = null;
            function scrollFrame(frameId, x, y) {
                const f = document.getElementById(frameId);
                f.contentWindow.scrollTo(x, y);
            }
            function onscroll() {
                console.log('in onscroll');
                let frame1 = document.getElementById('frame2');
                alert(frame1);
                frame1.addEventListener('scroll', e => {
                    console.log("frame: " + e);
                });
                frame1.contentWindow.addEventListener('scroll', e => {
                    console.log("contentWindow: " + e);
                });

            }
            function setFrameId(frameId) {
                console.log(frameId);
                focusFrameId = frameId;
            }
            setTimeout(onscroll, 500);*/

            // const dataFile = '/tools/importer/urls.json';
            // const dataFile = '/tools/importer/urls.json';
            const remoteHost = 'https://www.golfdigest.com';
            const myHost = (location.port !== 80) ? `${location.protocol}//${location.hostname}:3000` : `${location.protocol}//${location.hostname}`;
            const proxyHost = `${location.protocol}//${location.hostname}:3001`;
            const importRoot = 'https://sportsmagazine-poc--helix-sportsmagazine--headwirecom.hlx.page/import-test';
            const liveImportRoot = 'https://sportsmagazine-poc--helix-sportsmagazine--headwirecom.hlx.live/import-test';

            let data = [];
            let currentIndex = 0; 
            async function fetchData() {
                let pagePath = window.location.hash.trim();
                if (pagePath && pagePath.length > 0) {
                    pagePath = pagePath.replace('#','').replace('https://www.golfdigest.com/', '/');
                } else {
                    pagePath = null;
                }

                const pageType = (document.querySelector('.page-type')) ? document.querySelector('.page-type').value : 'gallery';
                const dataFile = `./${pageType}-urls.json`;
                const resp = await fetch(dataFile);
                if (resp.ok) {
                    const json = await resp.json();
                    data = json;
                    currentIndex = 0;
                    updateDisplay(pagePath);
                } else {
                    alert('error fetching url data file');
                    if (pagePath) {
                        updateDisplay(pagePath);
                    }
                }
            }
            function getRemoteUrl(path) {
                let rh = encodeURIComponent(remoteHost);
                return `${proxyHost}${path}?host=${rh}`;
            }
            function getImportedUrl(path) {
                let importedPath = path.replace(/\/content\/golfdigest-com\/en/, '').replace(fileName(path), fileName(path, '_', '-')).replace(/\.html$/, '');
                const operation = document.querySelector('.publish-op').value;
                let rootURL = (operation === 'live') ? liveImportRoot : importRoot;
                return `${rootURL}${importedPath}`;
            }
            function fileName(path, replaceStr, replaceWith) {
                const parts = path.split('/');
                let f = parts[parts.length-1];
                if (replaceStr && replaceWith) {
                    f = f.replaceAll(replaceStr, replaceWith);
                }
                return f;
            }
            function setUrlDisplay(container, url) {
                const a = document.createElement('a');
                a.innerHTML = url;
                a.href = url;
                a.target = '_blank';
                const c = document.createElement('div');
                c.append(a);
                container.innerHTML = c.innerHTML;
            }
            function compareUrl(url) {
                if(url) {
                    let path = url.replace('https://www.golfdigest.com/', '/');
                    updateDisplay(path);
                }
            }

            function updateComapreFrame(orgPath) {
                const newPath = getImportedUrl(orgPath);
                setUrlDisplay(document.getElementById('currentImportedURL'), newPath);
                document.getElementById('frame2').src = newPath;
            }
            function waitToLoad() {
                // console.log('waiting to load update page');
                let docBody = document.getElementById('frame1').contentDocument.body;
                let pagePath = (docBody) ? docBody.getAttribute("data-page-path") : null;
                console.log('waiting to load update page. Page path ' + pagePath);
                if (pagePath) {
                    let currentUrl = document.getElementById('url-text').value;
                    let urlFileName = fileName(currentUrl, '.html', '');
                    let pathFileName = fileName(pagePath);
                    if (urlFileName == pathFileName) {
                        updateComapreFrame(pagePath);
                    } else {
                        setTimeout(waitToLoad, 100);
                    }
                } else {
                    setTimeout(waitToLoad, 100);
                }
            }
            function updateDisplay(displayPath) {
                const path = (displayPath) ? displayPath : data[currentIndex];
                const url = `${remoteHost}${path}`;
                if (url !== document.getElementById('url-text').value.trim()) {
                    document.getElementById('url-text').value = url;
                }
                const orgFrame = document.getElementById('frame1');
                orgFrame.src = getRemoteUrl(path);
                
                if (path.startsWith('/content/golfdigest-com/en/')) {
                    setUrlDisplay(document.getElementById('currentImportedURL'), getImportedUrl(path));
                    updateComapreFrame(path);
                } else {
                    waitToLoad();
                }
            }
            function next() {
                if (currentIndex < data.length-1) {
                    currentIndex++;
                    updateDisplay();
                }
            }
            function prev() {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateDisplay();
                }
            }
            fetchData();

            function getPublishLogger() {
                logger = document.querySelector('.publish-logger');
                return logger.contentDocument.body;
            }
            function showLogger(show) {
                document.querySelector('.publish-logger-container').style.display = (show) ? 'block' : 'none';
                document.querySelector('.hide-log-btn').style.display = (show) ? 'block' : 'none';
                document.querySelector('.show-log-btn').style.display = (show) ? 'none' : 'block';
            }
            function appendLog(string) {
                let logger = getPublishLogger();
                if (logger) {
                    let line = document.createElement('p');
                    line.textContent = string;
                    logger.append(line);
                }
                console.log(string);
            }
            function clearLog() {
                let logger = getPublishLogger();
                logger.innerHTML = '';
            }
            function startBulk(operation) {
                if (!window.confirm(`Publishing \"${operation}\" ${data.length} pages!`)) {
                    return;
                }
                let urls = [];
                for (let i = 0; i < data.length; i++) {
                    let url = getImportedUrl(data[i]);
                    urls.push(url);
                }
                clearLog();
                showLogger(true);
                appendLog('Publishing ...')
                bulk(urls, operation, getPublishLogger());
            }
            function publish() {
                const operation = document.querySelector('.publish-op');
                //alert(operation.value);
                startBulk(operation.value);
            }

            setTimeout(()=>{
                document.getElementById('url-text').addEventListener('keyup', ({key})=>{
                    if (key.toLowerCase() === 'enter') {
                        compareUrl( document.getElementById('url-text').value.trim() );
                    }
                });
            },200);
        </script>
    </head>
    <body>
        <div class="main">
            <!--
            <div class="form">
                <span class="url"><input id="url-text" type="text" size="100"><button onclick="compareUrl( document.getElementById('url-text').value.trim() )">Compare</button></span>
            </div> -->
            <div class="form">
                Page Type:
                <select class="page-type" onchange="fetchData()">
                    <option value="gallery">Gallery</option>
                    <option value="article">Article</option>
                </select>
                <select class="publish-op" onchange="updateDisplay()">
                    <option value="preview">preview</option>
                    <option value="live">live</option>
                </select>
                <button class="publish-btn" onclick="publish()">Publish</button>
                <button id="prev-btn" onclick="prev()">Previous</button>
                <button id="next-btn" onclick="next()">Next</button>
            </div>
            <div class="publish-logger-container" style="display: none;">
                <iframe class="publish-logger"></iframe>
            </div>
            <div class="form">
                <span style="align-self: center;">
                <button class="show-log-btn log-btn" onclick="showLogger(true)">Show Publish Log</button>
                <button class="hide-log-btn log-btn" onclick="showLogger(false)">Hide Publish Log</button>
                </span>
            </div>
            <div style="display: flex">
                <!--<div id="currentRemoteURL" class="url-display"></div>-->
                <div class="url-display">
                    <span class="url"><input id="url-text" type="text" ><button style="float: right;" onclick="compareUrl( document.getElementById('url-text').value.trim() )">></button></span>
                </div>
                <div id="currentImportedURL" class="url-display"></div>
            </div>
            <div class="frames">
                <div class="frame-box">
                    <iframe onfocus="setFrameId('frame1')" id="frame1" class="frame" src=""></iframe>
                </div>
                <div class="frame-box">
                    <iframe onfocus="setFrameId('frame2')" id="frame2" class="frame" src=""></iframe>
                </div>
            </div>
        </div>
        <div class="publish-ui" style="display: none">
            <textarea class="id" style="display: none"></textarea>
            <select class="id" style="display: none">
                <option value="preview">preview</option>
                <option value="live">publish</option>
            </select>
            <button class="id" style="display: none">start</button>
            <div class="id logger">

            </div>
        </div>
    </body>
</html>